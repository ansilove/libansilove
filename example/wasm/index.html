<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>libansilove wasm smoke test</title>
  <script type="module">
    import createLibansilove from './libansilove.browser.mjs';

    const status = document.getElementById('status');
    const preview = document.getElementById('preview');

    async function render() {
      try {
        const Module = await createLibansilove({ locateFile: (path) => path });

        const getVersion = Module.cwrap('ansilove_wasm_version', 'string', []);
        const renderAnsi = Module.cwrap('ansilove_wasm_render_ansi', 'number', ['number', 'number', 'number', 'number', 'number', 'number']);
        const getPtr = Module.cwrap('ansilove_wasm_get_png_ptr', 'number', []);
        const getLength = Module.cwrap('ansilove_wasm_get_png_length', 'number', []);
        const freePng = Module.cwrap('ansilove_wasm_free_png', null, []);

        status.textContent = 'libansilove wasm version: ' + getVersion();

        const encoder = new TextEncoder();
        const input = encoder.encode('Hello from libansilove!\r\n');
        const ptr = Module._malloc(input.length);
        Module.HEAPU8.set(input, ptr);

        const rc = renderAnsi(ptr, input.length, 0, 0, 0, 0);
        Module._free(ptr);
        if (rc !== 0) {
          status.textContent = 'Render failed with error code ' + rc;
          return;
        }

        const pngPtr = getPtr();
        const pngLen = getLength();
        const pngData = Module.HEAPU8.slice(pngPtr, pngPtr + pngLen);
        freePng();

        const blob = new Blob([pngData], { type: 'image/png' });
        const url = URL.createObjectURL(blob);
        preview.src = url;
        preview.alt = 'Rendered ANSI sample';
      } catch (error) {
        status.textContent = 'Libansilove failed: ' + error;
      }
    }

    render();
  </script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 2rem; }
    main { max-width: 40rem; }
    #status { font-weight: bold; }
  </style>
</head>
<body>
  <main>
    <h1>libansilove wasm smoke test</h1>
    <p id="status">waiting for moduleâ€¦</p>
    <img id="preview" alt="" style="display:block; margin-top: 1rem; max-width: 100%;" />
  </main>
</body>
</html>
